{% extends 'base.html.twig' %}

{% block title %}Eventopia - Feedback
{% endblock %}

{% block navbar %}
	<div style="background-color:white; margin-bottom:95px;">
		{% include 'Front/navbar.html.twig' %}
	</div>
{% endblock %}

{% block body %}
	<style>
		.send:hover {
			color: blue;
		}
		.update:hover {
			background-color: rgba(136, 157, 242, 0.58);
			padding: 4px;
			border-radius: 4px;
		}
		.trash:hover {
			background-color: rgba(244, 95, 58, 0.58);
			padding: 4px;
			border-radius: 4px;
		}
		.modal-dialog.modal-lg {
			max-height: 90vh;
			height: 90%;
			margin: 30px auto;
		}
		.reply-section {
			display: none;
			transition: all 0.3s ease;
		}
		.toggle-replies-btn {
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.toggle-replies-btn:hover {
			color: #007bff !important;
		}
		.toggle-replies-btn.collapsed .fa-chevron-down {
			transform: rotate(-90deg);
		}
		.toggle-replies-btn .fa-chevron-down {
			transition: transform 0.3s ease;
		}
		.commented-section {
			margin: 20px 0;
			padding: 15px;
			background-color: #fff;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			width: 100%;
		}
		.reply-container {
			margin-left: 40px;
			border-left: 2px solid #eee;
			padding-left: 20px;
		}
		.search-container {
			position: relative;
			margin-bottom: 20px;
		}
		.search-input {
			border: 2px solid #0d6efd;
			border-radius: 20px;
			padding-left: 60px;
			width: 100%;
			transition: all 0.3s ease;
		}
		.search-input:focus {
			border-color: #0b5ed7;
			box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
		}
		#feedbackSearch::placeholder {
			padding-left: 10px;
		}
	</style>

	<div class="container-fluid mt-5 mb-5" style="padding-left:4%; padding-right:4%;">
		<div style="width: 100%; text-align: center; margin-bottom: 50px; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1572377200231-6525599ecaa4?q=80&w=2004&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; padding: 100px 20px; border-radius: 8px;">
			<h1 style="color: white; font-weight: bold; font-size: 2.5rem;">What's your feedback</h1>
			<p style="color: white; font-size: 1.2rem;">
				about
				<span style="color:white; font-weight: bold;">Eventopia</span>
			</p>
		</div>

		<div class="d-flex justify-content-center row">
			<div class="d-flex flex-column" style="width: 100%;">
				<div class="coment-bottom bg-white p-4 px-4 rounded shadow-sm">
					<form action="{{ path('app_feedback_add') }}" method="POST">
						<div class="d-flex flex-row add-comment-section mt-4 mb-4">
							<img class="img-fluid img-responsive rounded-circle mr-3" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQjDGMp734S91sDuUFqL51_xRTXS15iiRoHew&s" width="50px">
							<div class="input-group">
								<input type="text" class="form-control" name="comment" placeholder="Your feedback please..." required>
								<div class="input-group-append">
									<button class="btn btn-primary send-btn" type="submit">
										<i class="fa fa-paper-plane send"></i>
									</button>
								</div>
							</div>

						</div>
						<div id="flash-messages" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
							{% for label, messages in app.flashes %}
								{% for message in messages %}
									<div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
										{{ message }}
									</div>
								{% endfor %}
							{% endfor %}
						</div>
					</form>

					<hr class="mt-5 mb-4">

					<div class="row mb-4">
						<div class="col-md-6 mx-auto">
							<div class="search-container position-relative">
								<i class="fa fa-search search-icon position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%); color: #0d6efd; z-index: 10;"></i>
								<input type="text" id="feedbackSearch" class="form-control search-input pl-4" placeholder="Search feedback...">
							</div>
						</div>
					</div>

					<div id="noResultsContainer" class="commented-section" style="visibility: hidden; height: 0; padding: 0; margin: 0;">
						<div class="d-flex flex-row align-items-center commented-user">
							<div class="d-flex flex-column w-100">
								<div class="text-center py-4">
									<p class="text-muted m-0">No results found for your search.</p>
								</div>
							</div>
						</div>
					</div>

					<div id="feedbackContainer">
						{% for feedback in feedbacks %}
							<div class="commented-section">
								<div class="d-flex flex-row align-items-center commented-user">
									<img class="img-fluid img-responsive rounded-circle mr-3" src="{{ feedback.user.imageurl }}" width="40px">
									<div class="d-flex flex-column">
										<h5 class="mb-0">{{ feedback.user.prenom }}
											{{ feedback.user.nom }} </h5>
										<small class="text-muted">{{ feedback.createdAt|date("d/m/Y H:i") }}
											<button class="btn btn-link p-0 translate-btn" data-id="{{ feedback.id }}" data-lang="ar" title="Translate">
												<i class="fa fa-language"></i>
												AR
											</button>
										</small>

									</div>
									{# sentiment analyzer #}
									<div class="mb-4">
										<span class="badge sentiment-badge" data-comment="{{ feedback.comment }}" id="sentiment-{{ feedback.id }}" style="border-radius: 8px; font-size: 0.9rem;">

											<i class="fa fa-refresh fa-spin"></i>

										</span>
									</div>
									<div class="ml-auto d-flex">
										<button type="button" class="btn btn-link text-primary p-2" data-bs-toggle="modal" data-bs-target="#updateModal{{ feedback.id }}">
											<i class="fa fa-edit update" style="font-size: 25px;"></i>
										</button>
										<form method="post" action="{{ path('feedback_delete', {'id': feedback.id}) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this feedback?');">
											<button type="submit" class="btn btn-link text-danger p-2">
												<i class="fa fa-trash trash" style="font-size: 25px;"></i>
											</button>
										</form>
									</div>
								</div>

								<div class="comment-text-sm mt-3">
									<p id="comment-{{ feedback.id }}">{{ feedback.comment }}</p>

								</div>


								<div class="reply-container mt-3">
									<h6 class="toggle-replies-btn text-muted mb-3 collapsed d-flex align-items-center" data-toggle="collapse" data-target="#replies-{{ feedback.id }}">
										<i class="fa fa-reply mr-2"></i>
										<span>Replies ({{ feedback.replies|length }})</span>
										<i class="fa fa-chevron-down ml-2" style="font-size: 0.8rem;"></i>
									</h6>
									<div id="replies-{{ feedback.id }}" class="collapse">
										{% for reply in feedback.replies %}
											<div class="d-flex mb-3 p-3" style="background-color: #f8f9fa; border-radius: 8px;">
												<img class="img-fluid img-responsive rounded-circle mr-3" src="{{ reply.utilisateur.imageurl }}" width="36px">
												<div class="flex-grow-1">
													<div class="d-flex align-items-center mb-1">
														<span class="font-weight-bold mr-2">{{ reply.utilisateur.prenom }}
															{{ reply.utilisateur.nom }}</span>
														<small class="text-muted">{{ reply.createdAt|date('M d, Y h:i A') }}</small>
													</div>
													<p class="mb-0">{{ reply.comment }}</p>
												</div>

												<!-- Update & Delete Buttons for Replies -->
												<div
													class="ml-auto d-flex">
													<!-- Update Button (Triggers Modal) -->
													<button type="button" class="btn btn-link text-primary p-2" data-bs-toggle="modal" data-bs-target="#updateReplyModal{{ reply.id }}">
														<i class="fa fa-edit update" style="font-size: 20px;"></i>
													</button>

													<!-- Delete Button (Confirmation Popup) -->
													<form method="post" action="{{ path('reply_delete', {'id': reply.id}) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this reply?');">
														<button type="submit" class="btn btn-link text-danger p-2">
															<i class="fa fa-trash trash" style="font-size: 20px;"></i>
														</button>
													</form>
												</div>
											</div>

											<!-- Update Reply Modal (Similar to Feedback Modal) -->
											<div class="modal fade" id="updateReplyModal{{ reply.id }}" tabindex="-1" aria-hidden="true">
												<div class="modal-dialog">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title">Edit Reply</h5>
															<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
														</div>
														<div class="modal-body">
															<form action="{{ path('reply_update', {'id': reply.id}) }}" method="POST">
																<div class="mb-3">
																	<label class="form-label">Reply</label>
																	<textarea name="comment" class="form-control" rows="3">{{ reply.comment }}</textarea>
																</div>
																<button type="submit" class="btn btn-primary">Update</button>
															</form>

														</div>
													</div>
												</div>
											</div>
										{% else %}
											<p class="text-muted small mb-3">No replies yet. Be the first to respond!</p>
										{% endfor %}

										<form action="{{ path('reply_create', {'feedbackId': feedback.id}) }}" method="POST" class="mt-3">
											<div class="input-group">
												<input type="text" class="form-control" name="reply_comment" placeholder="Write your reply..." required style="border-radius: 20px 0 0 20px; border-right: none;">
												<div class="input-group-append">
													<button type="submit" class="btn btn-primary" style="border-radius: 0 20px 20px 0;">
														<i class="fa fa-paper-plane mr-1"></i>
														Send
													</button>
												</div>
											</div>
										</form>
									</div>
								</div>
							</div>

							<div class="modal fade" id="updateModal{{ feedback.id }}" tabindex="-1" aria-labelledby="updateModalLabel{{ feedback.id }}" aria-hidden="true">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title">Update your feedback</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<form action="{{ path('feedback_update', {'id': feedback.id}) }}" method="POST">
												<div class="mb-3">
													<label class="form-label">Feedback</label>
													<textarea name="comment" class="form-control" rows="3">{{ feedback.comment }}</textarea>
												</div>
												<button type="submit" class="btn btn-primary">Update feedback</button>
											</form>
										</div>
									</div>
								</div>
							</div>
						{% else %}
							<p class="text-center text-muted py-4">No comments yet.</p>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>


	<script>
		document.addEventListener('DOMContentLoaded', function () {
const searchInput = document.getElementById('feedbackSearch');
const feedbackItems = document.querySelectorAll('.commented-section:not(#noResultsContainer)');
const noResultsContainer = document.getElementById('noResultsContainer');

searchInput.addEventListener('input', function () {
const searchTerm = this.value.toLowerCase().trim();
let hasResults = false;

feedbackItems.forEach(item => {
const userName = item.querySelector('h5') ?. textContent.toLowerCase() || '';
const commentText = item.querySelector('.comment-text-sm p') ?. textContent.toLowerCase() || '';
const repliesText = Array.from(item.querySelectorAll('.reply-container p')).map(p => p.textContent.toLowerCase()).join(' ');

if (searchTerm === '' || userName.includes(searchTerm) || commentText.includes(searchTerm) || repliesText.includes(searchTerm)) {
item.style.display = '';
hasResults = true;
} else {
item.style.display = 'none';
}
});

noResultsContainer.style.visibility = hasResults ? 'hidden' : 'visible';
noResultsContainer.style.height = hasResults ? '0' : 'auto';
noResultsContainer.style.padding = hasResults ? '0' : '15px';
noResultsContainer.style.margin = hasResults ? '0' : '20px 0';
});
});
setTimeout(() => {
document.querySelectorAll('#flash-messages .alert').forEach(el => {
el.classList.remove('show');
el.classList.add('fade');
setTimeout(() => el.remove(), 500); // Remove from DOM after fade
});
}, 4000);
// /traduction****************************************************
document.querySelectorAll('.translate-btn').forEach(button => {
button.addEventListener('click', () => {
const id = button.dataset.id;
const commentEl = document.getElementById (`comment-${id}`);
const originalText = commentEl.textContent;
const targetLang = button.dataset.lang;
const sourceLang = targetLang === 'ar' ? 'en' : 'ar';

fetch('/translate', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify(
{text: originalText, source: sourceLang, target: targetLang}
)
}).then(response => response.json()).then(data => {
commentEl.textContent = data.translatedText;
button.dataset.lang = sourceLang;
button.innerHTML = targetLang === 'ar' ? '<i class="fa fa-language"></i> EN' : '<i class="fa fa-language"></i> AR';
}).catch(() => {
alert('Translation failed.');
});
});
});
// sentiment analyzer ***************************************
document.addEventListener("DOMContentLoaded", function () {
document.querySelectorAll(".sentiment-badge").forEach(function (badge) {
const comment = badge.getAttribute("data-comment");
console.log(comment);

fetch('/sentiment', {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: 'comment=' + encodeURIComponent(comment)
}).then(response => response.json()).then(data => {
console.log(data);
if (data.sentiment) {

badge.style.display = "inline-block";
badge.classList.add("ms-2");

badge.innerHTML = '';

switch (data.sentiment) {
case "positive": badge.innerHTML = ' <i class="fa fa-smile-o text-success" title="Positive sentiment"></i>';
break;
case "negative": badge.innerHTML = ' <i class="fa fa-frown-o text-danger" title="Negative sentiment"></i>';
break;
case "neutral":
default: badge.innerHTML = ' <i class="fa fa-meh-o text-secondary" title="Neutral sentiment"></i>';
break;
}

// badge.textContent = "Sentiment: " + data.sentiment.charAt(0).toUpperCase() + data.sentiment.slice(1);
}
}).catch(error => {
console.error("Error fetching sentiment:", error);
badge.innerHTML = '<i class="fa fa-question-circle text-warning" title="Sentiment analysis failed"></i>';
});
});
});
	</script>
{% endblock %}

{% block footer %}
	{% include 'Front/footer.html.twig' %}
{% endblock %}
