{% extends 'base.html.twig' %}

{% block title %}Eventopia - {{ event.titre }}{% endblock %}

{% block navbar %}
    <div style="background-color:white; margin-bottom:95px;">
        {% include 'Front/navbar.html.twig' %}
    </div>
{% endblock %}

{% block body %}
    <!-- Hero Section -->
    <div class="container-fluid px-0 mb-5">
        <div class="row g-0">
            <div class="col-md-8">
                <img src="{{ event.image ? '/uploads/images/' ~ event.image : 'https://via.placeholder.com/1200x600?text=Event+Image' }}" class="img-fluid w-100" style="height: 500px; object-fit: cover;" alt="{{ event.titre }}">
            </div>
            <div class="col-md-4 bg-light p-4 d-flex flex-column">
                <div class="mb-auto">
                    <h1 class="fw-bold mb-3">{{ event.titre }}</h1>

                    <!-- Status & Category Display -->
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="category-chip">
                            <span class="category-icon">✧</span>
                            <span>{{ event.categorie.value|default('General') }}</span>
                        </div>
                        <div class="status-chip {{ event.statut == 'actif' ? 'active' : 'inactive' }}">
                            <span class="status-icon">{{ event.statut == 'actif' ? '✓' : '⏸' }}</span>
                            <span>{{ event.statut|capitalize }}</span>
                        </div>
                    </div>

                    <!-- Date & Time - Apple Style -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="apple-icon">
                            <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 7V3M16 7V3M7 11H17M5 21H19C20.1046 21 21 20.1046 21 19V7C21 5.89543 20.1046 5 19 5H5C3.89543 5 3 5.89543 3 7V19C3 20.1046 3.89543 21 5 21Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="ms-3">
                            <small class="text-muted d-block">DATE & TIME</small>
                            <span class="fw-bold">{{ event.date|date('F j, Y \\a\\t H:i') }}</span>
                        </div>
                    </div>

                    <!-- Location - Apple Style -->
                    <div class="d-flex align-items-center mb-4">
                        <div class="apple-icon">
                            <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12.5C13.6569 12.5 15 11.1569 15 9.5C15 7.84315 13.6569 6.5 12 6.5C10.3431 6.5 9 7.84315 9 9.5C9 11.1569 10.3431 12.5 12 12.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 22C14 18 20 15.4183 20 10C20 5.58172 16.4183 2 12 2C7.58172 2 4 5.58172 4 10C4 15.4183 10 18 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <small class="text-muted d-block">LOCATION</small>
                            <span class="fw-bold">{{ event.espace.nom ?? 'Not specified' }}</span>
                        </div>
                       {% if user and user.getRole() == constant('App\\Enum\\Role::ORGANISATEUR') %}
    <a href="{{ path('app_espaces', {'eventId': event.id}) }}" class="btn btn-outline-primary ms-3 px-3 py-2 rounded-pill">
        <i class="fas fa-calendar-check me-2"></i> Reserve Space
    </a>
{% endif %}
                    </div>

                    <!-- Price & Booking -->
                    <div class="border-top pt-3 pt-md-4 mt-auto">
                        <div class="d-flex flex-column justify-content-between align-items-center gap-2">
                            <div>
                                <small class="text-muted d-block">PRICE FROM</small>
                                <h3 class="text-primary fw-bold mb-0">{{ event.prix }} TND</h3>
                            </div>
                            <div class="d-flex gap-2">
                                <!-- Book Now Button - Visible for all logged in users -->
                                {% if user %}
                                    <button type="button" class="btn btn-primary px-4 py-2 rounded-pill fw-bold" 
                                            onclick="openBookModal()">
                                        <i class="fas fa-ticket-alt me-2"></i>
                                        Book Now
                                    </button>
                                
                                    <!-- Manage Event Button - Only for organizers -->
                                    {% if user.getRole() == constant('App\\Enum\\Role::ORGANISATEUR') %}
                                        <a href="{{ path('front_gestionmateriel_reservation_materiel_index', {'eventId': event.id}) }}" 
                                           class="btn btn-outline-primary px-4 py-2 rounded-pill fw-bold">
                                            <i class="fas fa-cog me-2"></i>
                                            Manage Event
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <a href="{{ path('app_login') }}" class="btn btn-primary px-4 py-2 rounded-pill fw-bold">
                                        <i class="fas fa-sign-in-alt me-2"></i>
                                        Login to Book
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="">
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- About Section -->
                <div class="card border-0 shadow-sm rounded-3 mb-4">
                    <div class="card-body p-4">
                        <h2 class="fw-bold mb-4">About This Event</h2>
                        <div class="text-muted lh-lg">
                            {{ event.description|default('No description available') }}
                        </div>
                    </div>
                </div>

                <!-- Program Section -->
                {% if programmes|length > 0 %}
                    <div class="card border-0 shadow-sm rounded-3 mb-4">
                        <div class="card-body p-4">
                            <h2 class="fw-bold mb-4">Event Program</h2>
                            <div class="timeline">
                                {% for program in programmes %}
                                    <div class="timeline-item">
                                        <div class="timeline-time">
                                            {{ program.heureDebut|date('H:i') }}<br>-<br>{{ program.heureFin|date('H:i') }}
                                        </div>
                                        <div class="timeline-content">
                                            <h5 class="fw-bold">{{ program.activite }}</h5>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- QR Code Section -->
                <div class="card border-0 shadow-sm rounded-3 mb-4">
                    <div class="card-body text-center">
                        <h4 class="fw-bold mb-3">Event QR Code</h4>
                        <img src="{{ path('event_qrcode', {'id': event.id}) }}" 
                             alt="QR Code for {{ event.titre }}"
                             class="img-fluid mb-3 qr-code-img">
                        <p class="text-muted small">
                            Scan this code to save event details or share with friends
                        </p>
                        <div class="qr-instructions alert alert-info mt-3">
                            <h5>How to scan:</h5>
                            <ul class="text-start">
                                <li><strong>iPhone</strong>: Open camera and point at code</li>
                                <li><strong>Android</strong>: Long press on code in camera view</li>
                                <li><strong>Others</strong>: Use any QR scanner app</li>
                            </ul>
                        </div>
                        <a href="{{ path('event_qrcode', {'id': event.id}) }}" 
                           download="qrcode-{{ event.titre|slug }}.png"
                           class="btn btn-sm btn-outline-primary mt-2">
                           <i class="fas fa-download me-2"></i> Download QR
                        </a>
                    </div>
                </div>

                <!-- Location Section -->
                {% if event.espace and event.espace.localisation %}
                    <div class="card border-0 shadow-sm rounded-3 mb-4">
                        <div class="card-body p-0">
                            <div style="height: 200px; background: #eee;">
                                <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q={{ event.espace.localisation }}&output=embed" style="border: none;"></iframe>
                            </div>
                            <div class="p-4">
                                <h4 class="fw-bold mb-3">{{ event.espace.nom }}</h4>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                    {{ event.espace.localisation }}
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Event Details -->
                <div class="card border-0 shadow-sm rounded-3 mb-4">
                    <div class="card-body p-4">
                        <h4 class="fw-bold mb-4">Event Details</h4>

                        <!-- Price - Apple Style -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="apple-icon">
                                <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16.5 9.5L7.5 14.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 6C13.3807 6 14.5 7.11929 14.5 8.5C14.5 9.88071 13.3807 11 12 11C10.6193 11 9.5 9.88071 9.5 8.5C9.5 7.119 10.619 6 12 6Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 13C13.3807 13 14.5 14.1193 14.5 15.5C14.5 16.8807 13.3807 18 12 18C10.6193 18 9.5 16.8807 9.5 15.5C9.5 14.119 10.619 13 12 13Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="ms-3">
                                <small class="text-muted d-block">PRICE</small>
                                <span class="fw-bold">{{ event.prix }} TND</span>
                            </div>
                        </div>

                        <!-- Capacity - Apple Style -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="apple-icon">
                                <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17 20V19C17 16.7909 15.2091 15 13 15H11C8.79086 15 7 16.7909 7 19V20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="ms-3">
                                <small class="text-muted d-block">CAPACITY</small>
                                <span class="fw-bold">{{ event.capacite ?? 'Not specified' }}</span>
                            </div>
                        </div>

                        <!-- Duration - Apple Style -->
                        <div class="d-flex align-items-center">
                            <div class="apple-icon">
                                <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/>
                                </svg>
                            </div>
                            <div class="ms-3">
                                <small class="text-muted d-block">DURATION</small>
                                <span class="fw-bold">{{ event.duree ?? 'Not specified' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'Front/comments.html.twig' %}

    <!-- Booking Modal -->
    <div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Book: {{ event.titre }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBodyContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
    function calculateTotal(unitPrice) {
        const places = document.getElementById('places')?.value;
        if (places) {
            document.getElementById('totalPrice').textContent = (places * unitPrice).toFixed(2);
        }
    }

    function openBookModal() {
        const modal = new bootstrap.Modal(document.getElementById('bookModal'));
        
        fetch(`/event/{{ event.id }}/book`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('modalBodyContent').innerHTML = html;
                modal.show();
            });
    }

    function submitReservationForm(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const spinner = document.getElementById('spinner');
        
        submitBtn.disabled = true;
        submitText.textContent = 'Processing...';
        spinner.classList.remove('d-none');
        
        fetch("{{ path('event_book', {'id': event.id}) }}", {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(async response => {
            let data;
            try {
                data = await response.json();
            } catch (e) {
                const text = await response.text();
                console.error('Server returned invalid JSON. Raw response:', text);
                throw new Error('Unexpected server error (invalid response)');
            }

            if (!response.ok) {
                throw new Error(data.message || 'Server error');
            }
            return data;
        })
        .then(data => {
            if (!data.success) throw new Error(data.message);

            let message = data.message;
            if (message.includes('not sent')) {
                message += '<br><small>We are experiencing technical issues with our email service</small>';
            }

            document.getElementById('formMessages').innerHTML = `
                <div class="alert alert-success">${message}<br>Total: ${data.total} TND</div>
            `;

            setTimeout(() => {
                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide();
            }, 2000);
        })
        .catch(error => {
            document.getElementById('formMessages').innerHTML = `
                <div class="alert alert-danger">${error.message}</div>
            `;
            console.error('Error:', error);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitText.textContent = 'Confirm';
            spinner.classList.add('d-none');
        });
    }

    // Initialize total price calculation
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotal({{ event.prix }});
        
        // QR Compatibility Check
        const isOldIOS = /iPhone OS (9|10|11)_/.test(navigator.userAgent);
        const isLegacyAndroid = /Android [2-6]/.test(navigator.userAgent);
        
        if (isOldIOS || isLegacyAndroid) {
            const qrSection = document.querySelector('.qr-instructions');
            if (qrSection) {
                qrSection.innerHTML += `
                    <div class="alert alert-warning mt-2">
                        Your device may need a QR scanner app.
                        <a href="https://play.google.com/store/apps/details?id=com.qrcode.reader" target="_blank">Download scanner</a>
                    </div>
                `;
            }
        }
    });
    </script>

{% endblock %}

{% block footer %}
    {% include 'Front/footer.html.twig' %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Apple-style Icon Container */
        .apple-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            color: #333;
        }
        .apple-icon svg {
            width: 24px;
            height: 24px;
        }

        /* Category & Status Chips */
        .category-chip,
        .status-chip {
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }
        .category-chip {
            background: #e7f5ff;
            color: #1971c2;
        }
        .status-chip {
            background: #ebfbee;
            color: #2b8a3e;
        }
        .status-chip.inactive {
            background: #fff3bf;
            color: #e67700;
        }
        .category-icon,
        .status-icon {
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            padding-left: 80px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 40px;
            width: 2px;
            background: #e9ecef;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-time {
            position: absolute;
            left: -80px;
            width: 70px;
            text-align: right;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .timeline-content {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Card Styles */
        .card {
            transition: transform 0.2s ease;
            border-radius: 12px !important;
        }
        .card:hover {
            transform: translateY(-3px);
        }

        /* QR Code Styles */
        .qr-code-img {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            display: block;
            border: 1px solid #eee;
            padding: 10px;
            background: white;
        }
        .qr-instructions {
            font-size: 0.85rem;
        }
        .qr-instructions ul {
            padding-left: 1.5rem;
            margin-bottom: 0;
        }

        /* Text Styles */
        .lh-lg {
            line-height: 1.8;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            border-bottom: 1px solid #eee;
        }
    </style>
{% endblock %}